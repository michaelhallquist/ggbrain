% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cluster_slices.R
\name{cluster_slices}
\alias{cluster_slices}
\title{Find slice locations based on cluster centers of mass in a 3D brain image}
\usage{
cluster_slices(
  images = NULL,
  layer = NULL,
  definition = NULL,
  nclusters = 10,
  min_clust_size = 1,
  plane = "axial",
  nn = 3,
  outline = FALSE,
  outline_color = NULL,
  outline_size = 1L,
  outline_scale = NULL,
  outline_show_legend = NULL
)
}
\arguments{
\item{images}{A ggbrain_images object or a named character vector of image file paths.
Required for computing cluster locations.}

\item{layer}{The name of a geom_brain layer whose definition should be used for clustering.
Mutually exclusive with \code{definition}. When using \code{layer}, the function returns
a deferred specification that is resolved during rendering when layer definitions are available.}

\item{definition}{A definition string (same syntax as geom_brain) specifying the image/contrast
to use for clustering. Examples: \code{"overlay"}, \code{"overlay[overlay > 2.5]"},
\code{"overlay[abs(overlay) > 2.5]"}. Mutually exclusive with \code{layer}.}

\item{nclusters}{Maximum number of clusters to return slices for. Clusters are sorted by
size (descending), and the top \code{nclusters} are selected. Default: 10}

\item{min_clust_size}{Minimum cluster size in voxels. Clusters smaller than this are ignored. Default: 1}

\item{plane}{The plane for slice selection: \code{"axial"} (z), \code{"sagittal"} (x),
or \code{"coronal"} (y). Default: \code{"axial"}}

\item{nn}{Neighborhood connectivity for defining clusters. Must be 1, 2, or 3:
\itemize{
\item \code{nn=1}: 6-connectivity (faces touching only)
\item \code{nn=2}: 18-connectivity (faces and edges touching)
\item \code{nn=3}: 26-connectivity (faces, edges, and corners touching)
}
Default: 3 (most inclusive)}

\item{outline}{Logical. If \code{TRUE}, a cluster outline mask is generated and automatically
added as a \code{geom_outline()} layer during rendering. Default: \code{FALSE}}

\item{outline_color}{A single color string for all cluster outlines. If \code{NULL} (default),
distinct colors are assigned to each cluster using the "Dark 3" HCL palette. Mutually
exclusive with \code{outline_scale}.}

\item{outline_size}{Integer specifying the outline thickness in pixels. Default: 1}

\item{outline_scale}{A ggplot2 scale object (e.g., \code{scale_fill_manual}) to use for
cluster outline colors. Mutually exclusive with \code{outline_color}.}

\item{outline_show_legend}{Logical. Whether to show a legend for cluster outlines. If
\code{NULL} (default), a legend is shown when multiple clusters exist.}
}
\value{
If \code{images} is provided along with \code{definition}, returns a character vector
of slice coordinates (e.g., \code{c("z = 10.5", "z = -3.2")}) suitable for passing to
\code{slices()}. If \code{layer} is specified or \code{images} is not provided, returns
a deferred specification object (class \code{"cluster_slices_spec"}) that will be resolved
during the ggbrain rendering pipeline.
}
\description{
This function identifies connected clusters in a brain image (after applying
an optional definition/contrast) and returns slice coordinates corresponding to the
center of mass of each cluster. This is useful for automatically selecting slices
that display the most relevant activation clusters.
}
\details{
The function performs 3D connected component labeling on the thresholded/masked image
to identify distinct clusters. For each cluster meeting the minimum size criterion,
the center of mass is computed. Slices are then selected at the center of mass
coordinates along the specified plane.

When \code{outline = TRUE}, a thin outline mask is also generated for the selected clusters.
This outline can be automatically added as a \code{geom_outline()} layer during rendering so
that clusters are highlighted on each slice. By default, distinct colors are assigned to each
cluster using a categorical palette, but a single \code{outline_color} or a custom vector of
colors can also be provided. The outline thickness can be controlled via
\code{outline_size}.

The neighborhood connectivity parameter (\code{nn}) controls how voxels are considered
connected:
\itemize{
\item \code{nn=1} (6-connectivity): Only voxels sharing a face are connected
\item \code{nn=2} (18-connectivity): Voxels sharing a face or edge are connected
\item \code{nn=3} (26-connectivity): Voxels sharing a face, edge, or corner are connected
}
}
\examples{
\dontrun{
  # Using a definition string directly
  t1 <- system.file("extdata", "mni_template_2009c_2mm.nii.gz", package = "ggbrain")
  overlay <- system.file("extdata", "pe_ptfce_fwep_0.05_2mm.nii.gz", package = "ggbrain")

  gg_obj <- ggbrain() +
    images(c(underlay = t1, overlay = overlay)) +
    slices(cluster_slices(
      images = c(overlay = overlay),
      definition = "overlay[abs(overlay) > 2.5]",
      nclusters = 5,
      min_clust_size = 50,
      plane = "axial"
    )) +
    geom_brain("underlay") +
    geom_brain(definition = "overlay[abs(overlay) > 2.5]")

  # Or defer resolution until render time (images from ggbrain pipeline)
  gg_obj <- ggbrain() +
    images(c(underlay = t1, overlay = overlay)) +
    slices(cluster_slices(
      definition = "overlay[abs(overlay) > 2.5]",
      nclusters = 5
    )) +
    geom_brain("underlay") +
    geom_brain(definition = "overlay[abs(overlay) > 2.5]")
}

}
