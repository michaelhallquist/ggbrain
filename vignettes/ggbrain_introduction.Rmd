---
title: "Introduction to ggbrain"
author: "Michael Hallquist"
date: "7/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggbrain)
```

# Overview of ggbrain

The `ggbrain` package uses the `ggplot2` package to create volume renderings of NIfTI files containing MRI data. It seeks to follow the principles of a graphical grammar in which plots are built from 

## The hierarchy of a ggbrain plot

Every ggbrain plot is composed of one or more panels that have layers representing different images that have been overlaid. Each panel contains a slice along one of the three axes of the volume: x (Left-Right), y (Anterior-Posterior), or z (Superior-Inferior). Panels can also contain annotations that reflect one or more marks to aid in the interpretation of the plot, as well as region labels in which text is positioned at certain markers within the displayed brain slice.

- Plot
  - Panels (aka Slices)
    - Layers: each pixel in the 2D slice contains a value such as a test statistic from a voxelwise analysis. Pixel values can also be categorical, such as levels of a factor (e.g., lobe).
    - Annotations: custom text or graphical marks overlaid on the panel using the ggplot2 `annotate` function (e.g., coordinate label)
    - Region Labels: a variant of ggplot2 `geom_text`, region labels represent text that should be overlaid at one or more spatial positions across the panel/slice (e.g., anatomical labels)
    
# Building a ggbrain plot layer by layer

One can create an empty ggbrain object using the `ggbrain` function.

```{r}
gg_obj <- ggbrain()
```

Consistent with the `ggplot2` approach, additional elements can be added using the `+` operator, as we elaborate below. The main thing to know at this point is that **you need to add all ggbrain-specific elements before adding typical ggplot components such as `theme()`**.

## Add images

A ggbrain plot must have at least one 3D image stored in NIfTI format. These images are read into ggbrain using the `RNifti` package. All images for a given plot must have the same image dimensions (otherwise, an error will occur).

The file names containing relevant images can be passed in as arguments to `ggbrain` or they can be appended using `add_images()` In either, it is important to provide a name for the image that is used internally to refer to the image in contrasts, labels, or other operations. If you do not provide a name, you will see a warning:

```
Warning message:
In private$set_images(images, fill_holes, clean_specks) :
  The images vector does not contain any names. This may lead to weird behaviors downstream if 'underlay' and 'overlay' are requested.
```

```{r}
underlay_3mm <- system.file("extdata", "mni_template_2009c_3mm.nii.gz", package="ggbrain")
gg_obj <- gg_obj + add_images(underlay=underlay_3mm)
```

Note that the image name of 'underlay' has a special meaning in the package. Specifically, using this name will set a default color scale that is grayscale and will not show the legend of this scale in the plot. You don't have to use 'underlay' but it can make things a bit simpler if you have a conventional plot that shows an anatomical scan underneath functional activations.

### Cleaning small 'specks' from image slices

